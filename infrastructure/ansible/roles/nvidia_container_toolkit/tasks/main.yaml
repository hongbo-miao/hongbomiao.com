# https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html
---
- name: Check if NVIDIA Container Toolkit is already installed
  ansible.builtin.stat:
    path: /usr/bin/nvidia-ctk
  register: nvidia_container_toolkit_check_result

- name: Install NVIDIA Container Toolkit if not present
  become: true
  when: not nvidia_container_toolkit_check_result.stat.exists
  block:
    - name: Download NVIDIA Container Toolkit GPG key
      ansible.builtin.get_url:
        url: "{{ nvidia_container_toolkit_gpg_key_url }}"
        dest: /tmp/nvidia-container-toolkit-gpgkey
        mode: '0644'
      notify: Add NVIDIA Container Toolkit GPG key to keyring
    - name: Download NVIDIA Container Toolkit repository list
      ansible.builtin.get_url:
        url: "{{ nvidia_container_toolkit_repo_list_url }}"
        dest: /etc/apt/sources.list.d/nvidia-container-toolkit.list
        mode: '0644'
    - name: Configure repository with signed-by keyring
      ansible.builtin.replace:
        path: /etc/apt/sources.list.d/nvidia-container-toolkit.list
        regexp: '^deb https://'
        replace: 'deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://'
    - name: Install NVIDIA Container Toolkit packages
      ansible.builtin.apt:
        name: "{{ nvidia_container_toolkit_packages }}"
        state: present
        update_cache: true
  always:
    - name: Clean up NVIDIA Container Toolkit GPG key
      ansible.builtin.file:
        path: /tmp/nvidia-container-toolkit-gpgkey
        state: absent

- name: Configure NVIDIA Container Runtime for Docker
  become: true
  ansible.builtin.command:
    cmd: nvidia-ctk runtime configure --runtime=docker
  register: nvidia_container_toolkit_configure_result
  changed_when: nvidia_container_toolkit_configure_result.stdout is search('Wrote updated config')
  notify: Restart Docker service
