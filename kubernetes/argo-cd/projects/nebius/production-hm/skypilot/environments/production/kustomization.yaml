# https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
helmCharts:
  - name: skypilot
    repo: https://helm.skypilot.co
    version: 0.11.1
    releaseName: skypilot
    namespace: production-hm-skypilot
    valuesFile: helm-chart/values.yaml
resources:
  - kubernetes-manifests/hm-skypilot-certificate.yaml
  - kubernetes-manifests/hm-skypilot-forward-authentication-middleware.yaml
  - kubernetes-manifests/hm-skypilot-ingress-route.yaml
  - kubernetes-manifests/hm-skypilot-secret.yaml
  - kubernetes-manifests/hm-skypilot-service-account-token-middleware.yaml
  - kubernetes-manifests/lambda-secret.yaml
  - kubernetes-manifests/nebius-secret.yaml
  - kubernetes-manifests/production-hm-skypilot-storage-class.yaml
  - kubernetes-manifests/runpod-secret.yaml
  - kubernetes-manifests/vast-secret.yaml
# https://github.com/skypilot-org/skypilot/issues/8726
# Use NamespaceTransformer with unsetOnly instead of top-level namespace field.
# This prevents overwriting the kube-system namespace in ClusterRoleBindings.
transformers:
  - |-
    apiVersion: builtin
    kind: NamespaceTransformer
    metadata:
      name: namespace-transformer
      namespace: production-hm-skypilot
    unsetOnly: true
patches:
  # https://github.com/skypilot-org/skypilot/issues/8711
  # Delete nginx Ingress resources - using Traefik IngressRoute instead
  - target:
      kind: Ingress
      name: skypilot-ingress
    patch: |
      $patch: delete
  - target:
      kind: Ingress
      name: skypilot-oauth2-proxy
    patch: |
      $patch: delete
