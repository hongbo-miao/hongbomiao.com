---
- name: Install common packages
  hosts: hm-ubuntu
  tasks:
    - name: Install common packages from Snap
      become: true
      become_user: root
      community.general.snap:
        name:
          - btop
          - htop
          - vnstat
        state: present

- name: Install pyenv
  hosts: hm-ubuntu
  vars:
    python_version: 3.11.4
  roles:
    - role: staticdev.pyenv
      # https://github.com/pyenv/pyenv/releases
      pyenv_version: v2.3.23
      pyenv_env: user
      pyenv_python_versions:
        - "{{ python_version }}"
      pyenv_global:
        - "{{ python_version }}"
  tasks:
    - name: Creates directory ~/pyenv/
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/pyenv/"
        state: directory
    - name: Set global Python version
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/pyenv/version"
        content: "{{ python_version }}"
        mode: 0644

- name: Install Poetry
  hosts: hm-ubuntu
  roles:
    - role: bartdorlandt.poetry

- name: Install Rclone
  hosts: hm-ubuntu
  tasks:
    - name: Install Rclone
      ansible.builtin.include_role:
        name: stefangweichinger.ansible_rclone
      vars:
        # https://github.com/stefangweichinger/ansible-rclone/blob/main/defaults/main.yml
        rclone_arch: arm64

- name: Start Prefect agent
  hosts: hm-ubuntu
  tasks:
    - name: Install packages from pip
      ansible.builtin.pip:
        name: prefect==2.11.3
        executable: "{{ ansible_env.HOME }}/pyenv/shims/pip"
      register: pip_package
    - name: Create systemd service file
      become: yes
      ansible.builtin.template:
        src: templates/prefect-agent.service
        dest: /etc/systemd/system/prefect-agent.service
        mode: 0644
      register: systemd_unit
    - name: Start prefect agent service
      become: yes
      ansible.builtin.systemd_service:
        name: prefect-agent
        state: "{{ 'restarted' if pip_package.changed or systemd_unit.changed else 'started' }}"
        enabled: yes
        daemon_reload: "{{ systemd_unit.changed }}"
