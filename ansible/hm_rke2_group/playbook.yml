---
- name: Install common packages
  hosts: all
  tasks:
    - name: Install common packages from Snap
      become: true
      community.general.snap:
        name:
          - btop
          - htop
          - vnstat
        state: present
    - name: Install common packages from Snap (classic confinement)
      become: true
      community.general.snap:
        name:
          - kubectl
        classic: true
        state: present
- name: Deploy RKE2
  hosts: all
  become: true
  roles:
    - role: lablabs.rke2
- name: Configure kubectl
  hosts: masters
  tasks:
    - name: Create .kube directory
      file:
        path: "{{ ansible_env.HOME }}/.kube"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
    - name: Copy RKE2 kubeconfig to user's home
      become: true
      copy:
        src: /etc/rancher/rke2/rke2.yaml
        dest: "{{ ansible_env.HOME }}/.kube/config"
        remote_src: true
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
    - name: Add KUBECONFIG to shell profile
      lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        line: 'export KUBECONFIG=$HOME/.kube/config'
        state: present
        create: yes
