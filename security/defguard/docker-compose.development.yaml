# https://docs.docker.com/reference/compose-file/
# https://github.com/DefGuard/defguard/blob/main/docker-compose.yaml
---
name: defguard-development
services:
  defguard-core:
    image: ghcr.io/defguard/defguard:1.6.3
    depends_on:
      - defguard-postgres
    environment:
      DEFGUARD_COOKIE_INSECURE: "true"
      DEFGUARD_SECRET_KEY: aa5a506b11d719dd7170f57f5d9947faf8eb0bc2be1325e42aa0237c3dcfd26456e73dff9eef3b12c7bcf8711b45e3e703d8e21ee1c08520f5e12e3f5772da94
      DEFGUARD_AUTH_SECRET: defguard-auth-secret
      DEFGUARD_GATEWAY_SECRET: defguard-gateway-secret
      DEFGUARD_YUBIBRIDGE_SECRET: defguard-yubibridge-secret
      DEFGUARD_DB_HOST: defguard-postgres
      DEFGUARD_DB_PORT: 5432
      DEFGUARD_DB_USER: defguard_admin
      DEFGUARD_DB_PASSWORD: defguard_passw0rd
      DEFGUARD_DB_NAME: defguard_db
      DEFGUARD_URL: http://localhost:8000
      RUST_BACKTRACE: 1
    ports:
      - '127.0.0.1:8000:8000'  # REST API
      - '127.0.0.1:50055:50055'  # gRPC

  defguard-gateway:
    image: ghcr.io/defguard/gateway:1.6.2
    depends_on:
      - defguard-core
    environment:
      DEFGUARD_GRPC_URL: http://defguard-core:50055
      DEFGUARD_STATS_PERIOD: 60
      DEFGUARD_TOKEN: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJEZWZHdWFyZCIsInN1YiI6IlRlc3ROZXQiLCJjbGllbnRfaWQiOiIiLCJleHAiOjU5NjE3NDcwNzYsIm5iZiI6MTY2Njc3OTc4MSwicm9sZXMiOltdfQ.uEUMnw_gO23W0K2q3N1lToeP0D2zAY1swr8N-84sRHA
      RUST_LOG: debug
    ports:
      - '127.0.0.1:50051:50051/udp'  # WireGuard endpoint
    cap_add:
      - NET_ADMIN
  defguard-postgres:
    image: docker.io/library/postgres:18.1-trixie
    volumes:
      - ./data/db:/var/lib/postgresql
    environment:
      POSTGRES_DB: defguard_db
      POSTGRES_USER: defguard_admin
      POSTGRES_PASSWORD: defguard_passw0rd
    ports:
      - '127.0.0.1:5432:5432'
