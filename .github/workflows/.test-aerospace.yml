---
name: . Test Aerospace

'on':
  workflow_call:
    inputs:
      # Workflows
      workflow:
        required: true
        type: boolean
      # Applications
      camera-radar-fusion:
        required: true
        type: boolean
      camera-radar-lidar-fusion:
        required: true
        type: boolean
      flightradar24:
        required: true
        type: boolean
      bluesky:
        required: true
        type: boolean
      hm-aerosandbox:
        required: true
        type: boolean
      hm-openaerostruct:
        required: true
        type: boolean
      x-plane-rest-api:
        required: true
        type: boolean
      x-plane-udp:
        required: true
        type: boolean

jobs:
  flightradar24-test:
    name: Flightradar24 | Test
    if: ${{ inputs.workflow || inputs.flightradar24 }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.4
        with:
          version: 0.9.15
          enable-cache: true
          cache-dependency-glob: aerospace/flightradar24/uv.lock
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version-file: aerospace/flightradar24/.python-version
      - name: Install dependencies
        working-directory: aerospace/flightradar24
        run: |
          uv sync --dev
      - name: Test
        working-directory: aerospace/flightradar24
        run: |
          uv run poe test-coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: hongbo-miao/hongbomiao.com
          directory: aerospace/flightradar24

  bluesky-test:
    name: BlueSky | Test
    if: ${{ inputs.workflow || inputs.bluesky }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.4
        with:
          version: 0.9.15
          enable-cache: true
          cache-dependency-glob: aerospace/bluesky/uv.lock
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version-file: aerospace/bluesky/.python-version
      - name: Install dependencies
        working-directory: aerospace/bluesky
        run: |
          uv sync --dev
      - name: Test
        working-directory: aerospace/bluesky
        run: |
          uv run poe test-coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: hongbo-miao/hongbomiao.com
          directory: aerospace/bluesky

  aerosandbox-test:
    name: AeroSandbox | Test
    if: ${{ inputs.workflow || inputs.hm-aerosandbox }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.4
        with:
          version: 0.9.15
          enable-cache: true
          cache-dependency-glob: aerospace/hm-aerosandbox/uv.lock
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version-file: aerospace/hm-aerosandbox/.python-version
      - name: Install dependencies
        working-directory: aerospace/hm-aerosandbox
        run: |
          uv sync --dev
      - name: Test
        working-directory: aerospace/hm-aerosandbox
        run: |
          uv run poe test-coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: hongbo-miao/hongbomiao.com
          directory: aerospace/hm-aerosandbox

  openaerostruct-test:
    name: OpenAeroStruct | Test
    if: ${{ inputs.workflow || inputs.hm-openaerostruct }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.4
        with:
          version: 0.9.15
          enable-cache: true
          cache-dependency-glob: aerospace/hm-openaerostruct/uv.lock
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version-file: aerospace/hm-openaerostruct/.python-version
      - name: Install dependencies
        working-directory: aerospace/hm-openaerostruct
        run: |
          uv sync --dev
      - name: Test
        working-directory: aerospace/hm-openaerostruct
        run: |
          uv run poe test-coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: hongbo-miao/hongbomiao.com
          directory: aerospace/hm-openaerostruct

  x-plane-rest-api-test:
    name: X-Plane (REST API) | Test
    if: ${{ inputs.workflow || inputs.x-plane-rest-api }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.4
        with:
          version: 0.9.15
          enable-cache: true
          cache-dependency-glob: aerospace/x-plane/rest-api/uv.lock
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version-file: aerospace/x-plane/rest-api/.python-version
      - name: Install dependencies
        working-directory: aerospace/x-plane/rest-api
        run: |
          uv sync --dev
      - name: Test
        working-directory: aerospace/x-plane/rest-api
        run: |
          uv run poe test-coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: hongbo-miao/hongbomiao.com
          directory: aerospace/x-plane/rest-api

  x-plane-udp-test:
    name: X-Plane (UDP) | Test
    if: ${{ inputs.workflow || inputs.x-plane-udp }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.4
        with:
          version: 0.9.15
          enable-cache: true
          cache-dependency-glob: aerospace/x-plane/udp/uv.lock
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version-file: aerospace/x-plane/udp/.python-version
      - name: Install dependencies
        working-directory: aerospace/x-plane/udp
        run: |
          uv sync --dev
      - name: Test
        working-directory: aerospace/x-plane/udp
        run: |
          uv run poe test-coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: hongbo-miao/hongbomiao.com
          directory: aerospace/x-plane/udp

  camera-radar-fusion-test:
    name: Camera-Radar Fusion | Test
    if: ${{ inputs.workflow || inputs.camera-radar-fusion }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.4
        with:
          version: 0.9.15
          enable-cache: true
          cache-dependency-glob: autonomy/camera-radar-fusion/uv.lock
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version-file: autonomy/camera-radar-fusion/.python-version
      - name: Install dependencies
        working-directory: autonomy/camera-radar-fusion
        run: |
          uv sync --dev
      - name: Test
        working-directory: autonomy/camera-radar-fusion
        run: |
          uv run poe test-coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: hongbo-miao/hongbomiao.com
          directory: autonomy/camera-radar-fusion

  camera-radar-lidar-fusion-test:
    name: Camera-Radar-Lidar Fusion | Test
    if: ${{ inputs.workflow || inputs.camera-radar-lidar-fusion }}
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
        with:
          cache: true
          rust-src-dir: autonomy/camera-radar-lidar-fusion
      - name: Install system dependencies
        uses: awalsh128/cache-apt-pkgs-action@v1.6.0
        with:
          packages: build-essential clang cmake libavcodec-dev libavformat-dev libclang-dev libjpeg-dev libpng-dev libswscale-dev libtbb-dev libtiff-dev pkg-config
          version: 1.0
      - name: Install OpenCV
        run: |
          # https://docs.opencv.org/4.12.0/d2/de6/tutorial_py_setup_in_ubuntu.html
          git clone --depth 1 --branch 4.12.0 https://github.com/opencv/opencv.git /tmp/opencv
          mkdir /tmp/opencv/build
          cmake -S /tmp/opencv -B /tmp/opencv/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_LIST=core,imgproc,imgcodecs,dnn \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_opencv_apps=OFF
          cmake --build /tmp/opencv/build --parallel $(nproc)
          sudo cmake --install /tmp/opencv/build
          sudo ldconfig
      - name: Install dependencies
        working-directory: autonomy/camera-radar-lidar-fusion
        run: |
          cargo build
      - name: Test
        working-directory: autonomy/camera-radar-lidar-fusion
        run: |
          cargo test --all-features
