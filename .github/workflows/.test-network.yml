---
name: . Test Network

'on':
  workflow_call:
    inputs:
      # Workflows
      workflow:
        required: true
        type: boolean
      # Applications
      arrow-flight-client:
        required: true
        type: boolean
      arrow-flight-server:
        required: true
        type: boolean
      dust-dds-publisher:
        required: true
        type: boolean
      dust-dds-subscriber:
        required: true
        type: boolean
      rti-connext-dds:
        required: true
        type: boolean
      udp-receiver:
        required: true
        type: boolean
      udp-sender:
        required: true
        type: boolean

jobs:
  udp-receiver-test:
    name: UDP Receiver | Test
    if: ${{ inputs.workflow || inputs.udp-receiver }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      # protoc is for prost
      - name: Install protoc
        uses: arduino/setup-protoc@v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: 28.3
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
        with:
          cache: true
          rust-src-dir: network/udp/udp-receiver
      - name: Install dependencies
        working-directory: network/udp/udp-receiver
        run: |
          cargo build
      - name: Test
        working-directory: network/udp/udp-receiver
        run: |
          cargo test --all-features

  udp-sender-test:
    name: UDP Sender | Test
    if: ${{ inputs.workflow || inputs.udp-sender }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      # protoc is for prost
      - name: Install protoc
        uses: arduino/setup-protoc@v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: 28.3
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
        with:
          cache: true
          rust-src-dir: network/udp/udp-sender
      - name: Install dependencies
        working-directory: network/udp/udp-sender
        run: |
          cargo build
      - name: Test
        working-directory: network/udp/udp-sender
        run: |
          cargo test --all-features

  arrow-flight-client-test:
    name: Arrow Flight Client | Test
    if: ${{ inputs.workflow || inputs.arrow-flight-client }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.6
        with:
          version: 0.9.18
          enable-cache: true
          cache-dependency-glob: data-transport/arrow-flight/arrow-flight-client/uv.lock
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version-file: data-transport/arrow-flight/arrow-flight-client/.python-version
      - name: Install dependencies
        working-directory: data-transport/arrow-flight/arrow-flight-client
        run: |
          uv sync --dev
      - name: Test
        working-directory: data-transport/arrow-flight/arrow-flight-client
        run: |
          uv run poe test-coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: hongbo-miao/hongbomiao.com
          directory: data-transport/arrow-flight/arrow-flight-client

  arrow-flight-server-test:
    name: Arrow Flight Server | Test
    if: ${{ inputs.workflow || inputs.arrow-flight-server }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
        with:
          cache: true
          rust-src-dir: data-transport/arrow-flight/arrow-flight-server
      - name: Install dependencies
        working-directory: data-transport/arrow-flight/arrow-flight-server
        run: |
          cargo build
      - name: Test
        working-directory: data-transport/arrow-flight/arrow-flight-server
        run: |
          cargo test --all-features

  rti-connext-dds-test:
    name: RTI Connext DDS | Test
    if: ${{ inputs.workflow || inputs.rti-connext-dds }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.6
        with:
          version: 0.9.18
          enable-cache: true
          cache-dependency-glob: data-transport/rti-connext-dds/uv.lock
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version-file: data-transport/rti-connext-dds/.python-version
      - name: Install dependencies
        working-directory: data-transport/rti-connext-dds
        run: |
          uv sync --dev
      - name: Test
        working-directory: data-transport/rti-connext-dds
        run: |
          uv run poe test-coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: hongbo-miao/hongbomiao.com
          directory: data-transport/rti-connext-dds

  dust-dds-publisher-test:
    name: Dust DDS Publisher | Test
    if: ${{ inputs.workflow || inputs.dust-dds-publisher }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
        with:
          cache: true
          rust-src-dir: data-transport/dust-dds/dust-dds-publisher
      - name: Install dependencies
        working-directory: data-transport/dust-dds/dust-dds-publisher
        run: |
          cargo build
      - name: Test
        working-directory: data-transport/dust-dds/dust-dds-publisher
        run: |
          cargo test --all-features

  dust-dds-subscriber-test:
    name: Dust DDS Subscriber | Test
    if: ${{ inputs.workflow || inputs.dust-dds-subscriber }}
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
        with:
          cache: true
          rust-src-dir: data-transport/dust-dds/dust-dds-subscriber
      - name: Install dependencies
        working-directory: data-transport/dust-dds/dust-dds-subscriber
        run: |
          cargo build
      - name: Test
        working-directory: data-transport/dust-dds/dust-dds-subscriber
        run: |
          cargo test --all-features
